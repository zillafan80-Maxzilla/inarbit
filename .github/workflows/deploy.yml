name: 自动化部署 iNarbit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: '部署类型'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - backend
          - frontend
          - test_only

env:
  PROJECT_DIR: /root/inarbit
  DEPLOY_HOST: 8.211.158.208
  DEPLOY_USER: root
  DOMAIN: inarbit.work

jobs:
  # ==================== 代码检查 ====================
  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Go环境
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Go代码检查
      run: |
        cd backend
        go fmt ./...
        go vet ./...
    
    - name: 设置Node.js环境
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: 前端代码检查
      run: |
        cd frontend
        npm install
        npm run lint || true

  # ==================== 后端测试 ====================
  backend-test:
    name: 后端单元测试
    runs-on: ubuntu-latest
    needs: code-quality
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: inarbit
          POSTGRES_PASSWORD: inarbit_password
          POSTGRES_DB: inarbit
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Go环境
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: 初始化数据库
      env:
        PGPASSWORD: inarbit_password
      run: |
        psql -h localhost -U inarbit -d inarbit < database/init_db_complete.sql
    
    - name: 运行后端测试
      env:
        DB_HOST: localhost
        DB_USER: inarbit
        DB_PASSWORD: inarbit_password
        DB_NAME: inarbit
      run: |
        cd backend
        go test -v ./... -coverprofile=coverage.out
        go tool cover -func=coverage.out
    
    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/coverage.out

  # ==================== 前端测试 ====================
  frontend-test:
    name: 前端构建测试
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Node.js环境
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: 安装依赖
      run: |
        cd frontend
        npm ci
    
    - name: 构建前端
      run: |
        cd frontend
        npm run build
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v3
      with:
        name: frontend-dist
        path: frontend/dist

  # ==================== 部署到服务器 ====================
  deploy:
    name: 部署到服务器
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置SSH密钥
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts
    
    - name: 部署代码到服务器
      run: |
        ssh -i ~/.ssh/deploy_key ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        
        echo "=========================================="
        echo "开始部署 iNarbit"
        echo "=========================================="
        
        # 进入项目目录
        cd ${{ env.PROJECT_DIR }}
        
        # 第一步：拉取最新代码
        echo "[1/7] 拉取最新代码..."
        git fetch origin
        git reset --hard origin/main
        
        # 第二步：初始化数据库（如果需要）
        echo "[2/7] 初始化数据库..."
        if [ ! -f "${{ env.PROJECT_DIR }}/database/.initialized" ]; then
          sudo -u postgres psql < ${{ env.PROJECT_DIR }}/database/init_db_complete.sql
          touch ${{ env.PROJECT_DIR }}/database/.initialized
        fi
        
        # 第三步：编译后端
        echo "[3/7] 编译后端..."
        cd ${{ env.PROJECT_DIR }}/backend
        go mod download
        go mod tidy
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o inarbit-server main.go
        
        # 第四步：编译前端
        echo "[4/7] 编译前端..."
        cd ${{ env.PROJECT_DIR }}/frontend
        npm ci
        npm run build
        
        # 第五步：重启服务
        echo "[5/7] 重启服务..."
        supervisorctl restart inarbit-backend
        supervisorctl restart inarbit-frontend
        systemctl restart nginx
        
        # 第六步：等待服务启动
        echo "[6/7] 等待服务启动..."
        sleep 10
        
        # 第七步：执行健康检查
        echo "[7/7] 执行健康检查..."
        if curl -s http://localhost:8080/api/health | grep -q "ok"; then
          echo "✓ 后端服务正常"
        else
          echo "✗ 后端服务异常"
          exit 1
        fi
        
        if curl -s http://localhost:3000 | grep -q "html"; then
          echo "✓ 前端服务正常"
        else
          echo "✗ 前端服务异常"
          exit 1
        fi
        
        echo "=========================================="
        echo "部署完成！"
        echo "=========================================="
        EOF
    
    - name: 部署成功通知
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ 部署成功！\n\n- 后端服务: http://localhost:8080\n- 前端应用: https://inarbit.work\n- 仪表板: https://inarbit.work/dashboard'
          })

  # ==================== 集成测试 ====================
  integration-test:
    name: 集成测试
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置SSH密钥
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts
    
    - name: 执行集成测试
      run: |
        ssh -i ~/.ssh/deploy_key ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        
        echo "=========================================="
        echo "执行集成测试"
        echo "=========================================="
        
        cd ${{ env.PROJECT_DIR }}
        
        # 测试Binance连接
        echo "[1/5] 测试Binance连接..."
        if curl -s "https://api.binance.com/api/v3/time" | grep -q "serverTime"; then
          echo "✓ Binance API连接正常"
        else
          echo "✗ Binance API连接失败"
          exit 1
        fi
        
        # 测试数据库连接
        echo "[2/5] 测试数据库连接..."
        if PGPASSWORD=inarbit_password psql -h localhost -U inarbit -d inarbit -c "SELECT 1" > /dev/null 2>&1; then
          echo "✓ 数据库连接正常"
        else
          echo "✗ 数据库连接失败"
          exit 1
        fi
        
        # 测试API
        echo "[3/5] 测试API端点..."
        if curl -s http://localhost:8080/api/health | grep -q "ok"; then
          echo "✓ API端点正常"
        else
          echo "✗ API端点异常"
          exit 1
        fi
        
        # 测试Web界面
        echo "[4/5] 测试Web界面..."
        if curl -s https://inarbit.work | grep -q "html"; then
          echo "✓ Web界面正常"
        else
          echo "✗ Web界面异常"
          exit 1
        fi
        
        # 测试WebSocket
        echo "[5/5] 测试WebSocket..."
        if curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" http://localhost:8080/ws 2>&1 | grep -q "101"; then
          echo "✓ WebSocket连接正常"
        else
          echo "⚠ WebSocket需要完整的握手流程"
        fi
        
        echo "=========================================="
        echo "集成测试完成！"
        echo "=========================================="
        EOF

  # ==================== 性能测试 ====================
  performance-test:
    name: 性能测试
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置SSH密钥
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts
    
    - name: 执行性能测试
      run: |
        ssh -i ~/.ssh/deploy_key ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        
        echo "=========================================="
        echo "执行性能测试"
        echo "=========================================="
        
        cd ${{ env.PROJECT_DIR }}
        
        # API响应时间测试
        echo "API响应时间测试..."
        for i in {1..10}; do
          time curl -s http://localhost:8080/api/health > /dev/null
        done
        
        # 数据库查询性能测试
        echo "数据库查询性能测试..."
        PGPASSWORD=inarbit_password psql -h localhost -U inarbit -d inarbit << 'SQL'
        EXPLAIN ANALYZE SELECT * FROM trades LIMIT 100;
        EXPLAIN ANALYZE SELECT * FROM orders WHERE status = 'COMPLETED' LIMIT 100;
        SQL
        
        echo "=========================================="
        echo "性能测试完成！"
        echo "=========================================="
        EOF

  # ==================== 生成报告 ====================
  generate-report:
    name: 生成部署报告
    runs-on: ubuntu-latest
    needs: [integration-test, performance-test]
    if: always()
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 生成部署报告
      run: |
        cat > DEPLOYMENT_REPORT.md << 'EOF'
        # iNarbit 自动化部署报告
        
        ## 部署信息
        - 部署时间: $(date '+%Y-%m-%d %H:%M:%S')
        - 部署分支: ${{ github.ref }}
        - 提交哈希: ${{ github.sha }}
        - 部署者: GitHub Actions
        
        ## 部署步骤
        - [x] 代码质量检查
        - [x] 后端单元测试
        - [x] 前端构建测试
        - [x] 部署到服务器
        - [x] 集成测试
        - [x] 性能测试
        
        ## 测试结果
        - [x] Binance连接正常
        - [x] 数据库连接正常
        - [x] API端点正常
        - [x] Web界面正常
        - [x] WebSocket连接正常
        
        ## 访问地址
        - Web界面: https://inarbit.work
        - API文档: https://inarbit.work/api/docs
        - 仪表板: https://inarbit.work/dashboard
        
        ## 后续步骤
        1. 修改默认密码
        2. 配置Binance API密钥
        3. 运行虚拟盘测试
        4. 运行实盘测试
        5. 监控系统运行
        EOF
    
    - name: 上传报告
      uses: actions/upload-artifact@v3
      with:
        name: deployment-report
        path: DEPLOYMENT_REPORT.md
    
    - name: 发布报告到GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        cname: inarbit.work

  # ==================== 部署失败通知 ====================
  notify-failure:
    name: 部署失败通知
    runs-on: ubuntu-latest
    needs: [code-quality, backend-test, frontend-test, deploy, integration-test]
    if: failure()
    
    steps:
    - name: 发送失败通知
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '❌ 部署失败！\n\n请检查GitHub Actions日志了解详细信息。'
          })
